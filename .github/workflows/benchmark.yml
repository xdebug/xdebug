name: Benchmark Xdebug performance

on:
    pull_request:

jobs:
    linux:
        runs-on: ubuntu-latest
        name: "Linux"
        strategy:
            fail-fast: false
            matrix:
                # php: ["8.0", "8.1", "8.2", "8.3", "8.4", "8.5"]
                php: ["8.4"]
        steps:
            -   uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: "${{ matrix.php }}"
                    coverage: none
                    ini-values: "session.save_path=/tmp"

            -   name: Install valgrind
                run: |
                    sudo apt-get update
                    sudo apt-get install -y valgrind
                    
            -   name: Compile
                run: |
                    ./.build.scripts/compile-for-benchmark.sh

            # -   name: create summary file
            #     run: |
            #         cd xdebug_app
            #         echo "### ðŸ•’ Performance Results" > summary.md 
            #         echo "| Xdebug | Command | Duration | Slowdown |" >> summary.md       
            #         echo "|--------|---------|---------:|---------:|" >> summary.md       

            -   name: Copy files
                run: |
                    sudo cp ./.github/benchmark-files/xdebug-benchmark.ini /etc/php/${{ matrix.php }}/cli/conf.d
                    php -v
    
            -   name: Set off mode
                run: echo "XDEBUG_MODE=off" >> $GITHUB_ENV
    
            -   name: benchmark with xdebug off
                run:  |
                      valgrind --tool=callgrind --dump-instr=yes --callgrind-out-file=callgrind.out -- php-cgi  -T1 -d max_execution_time=0 -d opcache.enable=1 -d opcache.jit=disable -d opcache.jit_buffer_size=128M -d opcache.validate_timestamps=0 ./.github/benchmark-files/bench.php
                      cat callgrind.out

            -   name: Set coverage mode
                run: echo "XDEBUG_MODE=coverage" >> $GITHUB_ENV

            -   name: benchmark with xdebug in coverage mode
                run:  |
                      valgrind --tool=callgrind --dump-instr=yes --callgrind-out-file=callgrind.out -- php-cgi  -T1 -d max_execution_time=0 -d opcache.enable=1 -d opcache.jit=disable -d opcache.jit_buffer_size=128M -d opcache.validate_timestamps=0 ./.github/benchmark-files/bench.php
                      cat callgrind.out

            # -   name: print summary file
            #     run: |
            #         cd xdebug_app
            #         cat summary.md >> $GITHUB_STEP_SUMMARY
    
                        